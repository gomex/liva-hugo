<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  <title>Liva | Personal blog template</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="This is meta description">
  <meta name="author" content="Themefisher">
  <meta name="generator" content="Hugo 0.92.2" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://demo.gethugothemes.com/liva/examplesite/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://demo.gethugothemes.com/liva/examplesite/plugins/slick/slick.css ">
  
  <link rel="stylesheet" href="https://demo.gethugothemes.com/liva/examplesite/plugins/themify-icons/themify-icons.css ">
  
  <link rel="stylesheet" href="https://demo.gethugothemes.com/liva/examplesite/plugins/venobox/venobox.css ">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://demo.gethugothemes.com/liva/examplesite/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://demo.gethugothemes.com/liva/examplesite/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://demo.gethugothemes.com/liva/examplesite/images/favicon.png " type="image/x-icon">

  <!-- google analitycs -->
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'Your ID', 'auto');
    ga('send', 'pageview');
  </script>

</head><body>
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom pl-0">
      <a class="navbar-brand mobile-view" href="https://demo.gethugothemes.com/liva/examplesite/"><img class="img-fluid"
          src="https://demo.gethugothemes.com/liva/examplesite/images/logo.png" alt="Liva | Personal blog template"></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <div class="desktop-view">
          <ul class="navbar-nav mr-auto">
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-facebook"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-twitter-alt"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-instagram"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-github"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-linkedin"></i></a>
            </li>
            
          </ul>
        </div>

        <a class="navbar-brand mx-auto desktop-view" href="https://demo.gethugothemes.com/liva/examplesite/"><img class="img-fluid"
            src="https://demo.gethugothemes.com/liva/examplesite/images/logo.png" alt="Liva | Personal blog template"></a>

        <ul class="navbar-nav">
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://demo.gethugothemes.com/liva/examplesite/about/">About</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://demo.gethugothemes.com/liva/examplesite/blog/">Post</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://demo.gethugothemes.com/liva/examplesite/contact/">Contact</a>
          </li>
          
          
        </ul>

        
        <!-- search -->
        <div class="search pl-lg-4">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://demo.gethugothemes.com/liva/examplesite//search" class="h-100">
              <input class="search-box px-4" id="search-query" name="s" type="search" placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        

        
      </div>
    </nav>
  </div>
</header>
<!-- /navigation -->

<section class="section-sm">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        
        <a href="/liva/examplesite/categories/english"
          class="text-primary">English</a>
        
        <a href="/liva/examplesite/categories/devops"
          class="text-primary">Devops</a>
        
        <a href="/liva/examplesite/categories/docker"
          class="text-primary">Docker</a>
        
        <a href="/liva/examplesite/categories/supervisord"
          class="text-primary">Supervisord</a>
        
        <h2>Do you need to execute more than one process per container?</h2>
        <div class="mb-3 post-meta">
          <span>By Themefisher</span>
          
          <span class="border-bottom border-primary px-2 mx-1"></span>
          <span>21 July 2018</span>
          
        </div>
        
        <div class="content mb-5">
          <h2 id="tldr">TL;DR</h2>
<p>You need more than one process in a container, so you need to follow some best practices to your container does not become just a &ldquo;lightweight machine&rdquo;.</p>
<h3 id="problem">Problem</h3>
<p>In my current job, I need to run many processes in the same container. This is a warning sign of problem in your service architecture and this will be a problem for a better usage of Cloud features, but if you can&rsquo;t modify this structure, you shouldn&rsquo;t introduce new problems on your project.</p>
<h3 id="premise">Premise</h3>
<p>We need to point out that a service running in container model isn&rsquo;t a machine. Container Docker is virtualization at the operating system level that is another level of abstraction. It is tempting to use the Docker container as a machine, but avoid bravely because this will cause indirect damage to resource management resource in the future.</p>
<h1 id="supervisor">Supervisor</h1>
<p>If you will use more than one process per container, you need a process manager, since your container does not have this by default because it wasn&rsquo;t made for this usage. This is usually done by &ldquo;init&rdquo; in a standard &ldquo;Unix-like&rdquo; operation system. Remember, we are already beyond the limits of best practices.</p>
<p>My advice is: (Supervisord)[http://supervisord.org/index.html]</p>
<p>Supervisor is a software client/server type that allows you control multiple processes in the Unix-like family operating system. Each process managed by supervisor is started as a subprocess.</p>
<p>Here are the advantages of using Supervisor:</p>
<ul>
<li><strong>Convenience</strong>: It is responsible for starting subprocesses. You can configure for all multiple processes to start when you start the supervisor, for example.</li>
<li><strong>Management</strong>: When you have multiple distinct processes, different ways to ensuring that it is working or not, with distinct commands, shapes, and files. Supervisor is responsible for enforcing standard by ensuring a layer of process management abstraction.</li>
<li><strong>Grouping</strong>: You can group processes and execute commands to the group rather than executing manually one by one.</li>
</ul>
<h1 id="most-relevant-components">Most relevant components</h1>
<ul>
<li><strong>supervisord</strong> - This is the process responsible for all subprocess management. It should be pid 1 in your container.</li>
<li><strong>supervisorctl</strong> - This is the client responsible for <strong>supervisord</strong> management through simple commands in your terminal. Communication between the <strong>supervisorctl</strong> and <strong>supervisord</strong> can be done by UNIX domain socket (local file) or TCP socket (network communication).</li>
</ul>
<h1 id="how-to-use">How to use</h1>
<p>We will use &ldquo;Debian-like&rdquo; base image.</p>
<h2 id="adding-in-your-dockerfile">Adding in your Dockerfile</h2>
<p>Add the following instructions:</p>
<pre tabindex="0"><code>RUN apt-get -qqy update &amp;&amp; \
    apt-get -qqy install python-pip supervisor &amp;&amp; \
    pip install supervisor-stdout &amp;&amp; \
    apt-get clean
</code></pre><p>Add in the bottom:</p>
<pre tabindex="0"><code>CMD [&quot;/usr/bin/supervisord&quot;,&quot;-c&quot;,&quot;/etc/supervisor/supervisord.conf&quot;]
</code></pre><h2 id="setting-up-the-supervisor">Setting up the supervisor</h2>
<p>Open the <strong>/etc/supervisor/supervisord.conf</strong> file and in the <strong>[supervisorord]</strong> session you must add the following line:</p>
<pre tabindex="0"><code>nodaemon=true
</code></pre><p>Now create a new session on <strong>/etc/supervisor/supervisord.conf</strong> file:</p>
<pre tabindex="0"><code>[eventlistener:stdout]
priority = 1
command = supervisor_stdout
buffer_size = 100
events = PROCESS_LOG
result_handler = supervisor_stdout:event_handler
</code></pre><p><a href="http://supervisord.org/configuration.html#eventlistener-x-section-settings">Eventlistener</a> is a <strong>supervisor</strong> feature that aims to enable a process to listen to <a href="http://supervisord.org/events.html#events">subprocess events</a> and handle it properly.</p>
<p><a href="https://github.com/coderanger/supervisor-stdout">supervisor_stdout</a> is a script created for redirecting sub process logs to the standard and error output of the supervisor.</p>
<p>The advantage of eventlistener usage lies in the fact that logs treated in this way are displayed in the supervisor log with a prefix, making it easier to figure out which subprocess is that log line.</p>
<h2 id="setting-up-the-process">Setting up the process</h2>
<p>We will use <strong>nginx</strong> as an example. It is important to note that this service can not be run as a daemon, it must be run in foreground mode. That means when you execute a process and it &ldquo;lock&rdquo; your terminal and you can&rsquo;t run new commands until it is finished.</p>
<p>Here is the example of <strong>nginx</strong> running in foreground:</p>
<pre tabindex="0"><code>/usr/sbin/nginx -g &quot;daemon off;&quot;
</code></pre><p>To set up a process in the supervisor you need to create a file inside the /etc/supervisor.d folder:</p>
<p>/etc/supervisor.d/nginx.conf</p>
<pre tabindex="0"><code>[program:nginx]
autostart=true
autorestart=false
priority=100
command=/usr/sbin/nginx -g &quot;daemon off;&quot;
stdout_events_enabled = true
stderr_events_enabled = true
</code></pre><p>Explaining line by line</p>
<pre tabindex="0"><code>[program:nginx]
</code></pre><p>Informs the name of subprocess.</p>
<pre tabindex="0"><code>autostart=true
</code></pre><p>Informs that once the supervisor starts, this subprocess will start automatically. This option is required for containers model, since you shouldn&rsquo;t have to access the container to execute any commands.</p>
<pre tabindex="0"><code>autorestart=false
</code></pre><p>Informs that your subprocess won&rsquo;t restart in case of failure. Remember that we aren&rsquo;t using a machine, it means that if the process failed, it needs to be turned off and another resource should be responsible for. If you use Docker with <a href="https://docs.docker.com/engine/swarm/">Swarm</a> <a href="https://docs.docker.com/engine/reference/builder/#healthcheck">HEALTHCHECK</a> instruction can handle this, but if your Docker cluster is Kubernetes you should use <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">liveness/readiness probes</a>.</p>
<pre tabindex="0"><code>priority=100
</code></pre><p>Informs the order that the process will start and shut down. A smaller number indicates that the process will start first and will be turned off last.</p>
<pre tabindex="0"><code>command=/usr/sbin/nginx -g &quot;daemon off;&quot;
</code></pre><p>Informs which command to use to run the process. Enter the absolute path of the command. You can use the <strong>which</strong> (# which nginx ) command to find it.</p>
<pre tabindex="0"><code>stdout_events_enabled = true
stderr_events_enabled = true
</code></pre><p>Informs that the standard output or error will issue an event, which will be captured by the <strong>eventlisterner</strong> previously configured in that article. In this case the <strong>eventlisterner</strong> will sent to the stdout and stderr of the supervisor, with due prefix, based on the best practices of log in container. Remember that logs sent to these outputs are automatically managed by the container tool.</p>
<h2 id="log-management">Log management</h2>
<p>Usually processes in foreground send their logs to stdout and stderr by default, but that is not the case for all logs from nginx, for example, it needs to receive specific settings for it.</p>
<p>In the file <strong>/etc/nginx/nginx.conf</strong> you need to modify the lines below:</p>
<pre tabindex="0"><code>access_log /var/log/nginx/access.log;
error_log /var/log/nginx/error.log;
</code></pre><p>For the following lines:</p>
<pre tabindex="0"><code>access_log /dev/stdout;
error_log /dev/stdout;
</code></pre><p>By default, nginx will send its log to stdout, but that still doesn&rsquo;t indicate that the logs for each site will also follow this pattern. You need to access the /etc/nginx/sites-available/<em>site_name</em> file and modify the same lines as previously reported:</p>
<pre tabindex="0"><code>access_log ...;
error_log ...;
</code></pre><p>For the following lines:</p>
<pre tabindex="0"><code>access_log /dev/stdout;
error_log /dev/stdout;
</code></pre><p>That is, you need to understand what process is working and verify how the log is managed and finally set it to be sent to <strong>stdout</strong> and <strong>stderr</strong>.</p>
<h2 id="managing-subprocesses">Managing subprocesses</h2>
<p>Now that you have everything configured, you can access your container and execute the following command:</p>
<pre tabindex="0"><code>supervisorctl status
</code></pre><p>This command will show all managed processes and their status, which can be the following:</p>
<ul>
<li><strong>STOPPED</strong>: Subprocess terminated or never started</li>
<li><strong>STARTING</strong>: Subprocess has been requested to start and it is initializing</li>
<li><strong>RUNNING</strong>: Subprocess is running</li>
<li><strong>BACKOFF</strong>: Subprocess entered the <em>STARTING</em> state, but was terminated before entering the <em>RUNNING</em> state</li>
<li><strong>STOPPING</strong>: Subprocess has received a request to terminate and is terminating</li>
<li><strong>EXITED</strong>: Subprocess has exited the RUNNING state (Keep an eye on the <em>exit code</em> )</li>
<li><strong>FATAL</strong>: Subprocess can&rsquo;t be successfully initialized</li>
<li><strong>UNKNOWN</strong>: Subprocess is in an unknown state (Normally a supervisor error)</li>
</ul>
<!-- raw HTML omitted -->
<p>The most commonly used commands are:</p>
<pre tabindex="0"><code>supervisorctl start nginx
supervisorctl stop nginx
supervisorctl restart nginx
</code></pre><p>If you modify any configuration within /etc/supervisor.d/nginx.conf the <em>restart</em> command will not be enough to apply your changes. You need to execute the command below:</p>
<pre tabindex="0"><code>supervisorctl update
</code></pre><p>This command will apply all the changes and will perform the <em>restart</em> on processes that have changed.</p>
<h3 id="thanks">Thanks</h3>
<p>My co-workers from Crossover](<a href="http://crossover.com">http://crossover.com</a>) who collaborate in presenting options and especially to <a href="https://www.linkedin.com/in/evgenyudalov/">Evgeny Udalov</a> who played a lot in this debate.</p>
<h3 id="sources">Sources</h3>
<ul>
<li><a href="http://supervisord.org">Supervisor</a></li>
<li><a href="http://veithen.github.io/2015/01/08/supervisord-redirecting-stdout.html">Redirecting to stdout</a></li>
<li><a href="https://rcaguilar.wordpress.com/2017/11/06/multi-process-docker-service/">Multi-process Docker Service</a></li>
</ul>

        </div>

        
        
      </div>
    </div>
  </div>
</section>


<section class="section-sm">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto text-center">
        <h2>Join Our Newsletter</h2>
        <p class="text-light px-md-5 py-4 border-left border-right border-primary">
          Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero</p>
        <form action="#" class="row justify-content-center">
          <div class="input-group col-md-8">
            <input type="text" class="form-control" placeholder="Your Email Address">
            <div class="input-group-append">
              <button class="input-group-text btn btn-primary">Subscribe</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>


<footer class="text-capitalize">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 text-center mb-5">
        <a href="https://demo.gethugothemes.com/liva/examplesite/"><img src="https://demo.gethugothemes.com/liva/examplesite/images/logo.png" alt="Liva | Personal blog template"></a>
      </div>
               
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Contact Me</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="tel:0124857985320"><i
                class="ti-mobile mr-3 text-primary"></i>0124857985320</a></li>
          
                     
          <li class="mb-3"><i class="ti-location-pin mr-3 text-primary"></i>Dhaka, Bangladedsh</li>
          
                     
          <li class="mb-3"><a class="text-dark" href="mailto:demo@email.com"><i
                class="ti-email mr-3 text-primary"></i>demo@email.com</a>
          
          </li>
        </ul>
      </div>
      
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Social Contacts</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="#">facebook</a></li>
          
          <li class="mb-3"><a class="text-dark" href="#">twitter</a></li>
          
          <li class="mb-3"><a class="text-dark" href="#">instagram</a></li>
          
          <li class="mb-3"><a class="text-dark" href="#">github</a></li>
          
          <li class="mb-3"><a class="text-dark" href="#">linkedin</a></li>
          
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Categories</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/ansible/">Ansible</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/blog/">Blog</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/carreira/">Carreira</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/devops/">Devops</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/devopsdays/">Devopsdays</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/dicas/">Dicas</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/docker/">Docker</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/english/">English</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/herois/">Herois</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/iac/">Iac</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/mac/">MAC</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/mentoria/">Mentoria</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/node/">Node</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/pipeline/">Pipeline</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/portugues/">Portugues</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/qa/">Qa</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/remoto/">Remoto</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/ruby/">Ruby</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/scratch/">Scratch</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/liva/examplesite/categories/supervisord/">Supervisord</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Quick Links</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://demo.gethugothemes.com/liva/examplesite/about/">About</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://demo.gethugothemes.com/liva/examplesite/blog/">Post</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://demo.gethugothemes.com/liva/examplesite/contact/">Contact</a></li>
          
        </ul>
      </div>
      <div class="col-12 border-top py-4 text-center">
        | copyright © 2021 <a href="https://themefisher.com/hugo-themes/">Themefisher</a> All Rights Reserved |
      </div>
    </div>
  </div>
</footer>

<script>
  var indexURL = "https://demo.gethugothemes.com/liva/examplesite/index.json"
</script>

<!-- JS Plugins -->

<script src="https://demo.gethugothemes.com/liva/examplesite/plugins/jQuery/jquery.min.js"></script>

<script src="https://demo.gethugothemes.com/liva/examplesite/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://demo.gethugothemes.com/liva/examplesite/plugins/slick/slick.min.js"></script>

<script src="https://demo.gethugothemes.com/liva/examplesite/plugins/venobox/venobox.min.js"></script>

<script src="https://demo.gethugothemes.com/liva/examplesite/plugins/search/fuse.min.js"></script>

<script src="https://demo.gethugothemes.com/liva/examplesite/plugins/search/mark.js"></script>

<script src="https://demo.gethugothemes.com/liva/examplesite/plugins/search/search.js"></script>

<!-- Main Script -->

<script src="https://demo.gethugothemes.com/liva/examplesite/js/script.min.js"></script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js"></script>
<div id="js-cookie-box" class="cookie-box cookie-box-hide">
	This site uses cookies. By continuing to use this website, you agree to their use. <span id="js-cookie-button" class="btn btn-sm btn-primary ml-2">I Accept</span>
</div>
<script>
	(function ($) {
		const cookieBox = document.getElementById('js-cookie-box');
		const cookieButton = document.getElementById('js-cookie-button');
		if (!Cookies.get('cookie-box')) {
			cookieBox.classList.remove('cookie-box-hide');
			cookieButton.onclick = function () {
				Cookies.set('cookie-box', true, {
					expires:  2 
				});
				cookieBox.classList.add('cookie-box-hide');
			};
		}
	})(jQuery);
</script>


<style>
.cookie-box {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  text-align: center;
  z-index: 9999;
  padding: 1rem 2rem;
  background: rgb(71, 71, 71);
  transition: all .75s cubic-bezier(.19, 1, .22, 1);
  color: #fdfdfd;
}

.cookie-box-hide {
  display: none;
}
</style>
</body>
</html>